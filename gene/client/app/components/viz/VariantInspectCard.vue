<style lang="sass" >
@import ../../../assets/sass/variables
#variant-inspect
  padding-left: 10px
  padding-top: 10px
  padding-right: 10px
  padding-bottom: 10px
  margin-bottom: 7px

  .multialign-loader
    font-size: 12px




    .refalt
    max-width: 200px
    white-space: normal
    display: inline-block
    word-break: break-all

  .aa-change
    max-width: 200px
    white-space: normal
    display: inline-block
    word-break: break-all

  #show-assessment-button
    padding: 0px
    height: 26px !important
    background-color: $app-button-color !important
    color: white !important
    margin: 0px
    padding-left: 10px
    padding-right: 10px

    i.material-icons
      font-size: 15px
      padding-right: 3px

  .subheader
    padding-bottom: 10px
    font-size: 13px
    color: $app-color
    margin-top: -5px

  #notes-input
    margin-top: 8px
    .input-group input
      color: $text-color
    .input-group
      padding: 10px 0 0
    .input-group
      label
        font-size: 13px
        line-height: 14px
        height: 18px
        top: 8px
        font-weight: normal
    .input-group__input
      min-height: 0px
      margin-top: 8px
    .input-group--text-field input
      font-size: 13px
      height: 14px
    .input-group
      padding-top: 0px
    .input-group__details:before
      background-color: $text-color
    .input-group__details:after
      background-color: $text-color




  .variant-inspect-body
    display: flex
    flex-direction: row
    flex-wrap: wrap
    justify-content: space-around
    padding-top: 5px



    #conservation-track
      .variant-text
        max-width: 120px



    .variant-inspect-column
      display: flex
      flex-direction: column
      padding: 5px
      padding-left: 0px
      min-width: 150px
      max-width: 210px
      margin-bottom: 0px
      margin-right: 15px
      padding-top: 0px
      padding-bottom: 0px


      &.last
        border-right: none

      .variant-column-header
        font-size: 14px
        color:  $app-color
        margin-top: 5px
        margin-bottom: 15px

        hr
          margin-top: 1px
          margin-bottom: 5px
          height: 1px

      .variant-row
        display: flex
        flex-direction: row
        font-size: 13px
        margin-bottom: 10px
        max-width: 260px
        align-items: flex-start

        &.last
          margin-bottom: 0px

      .pheno-search-term
        max-width: 90px
        display: inline-block
        vertical-align: top
        line-height: 14px

      #qual-track
        margin-top: 0px
        #depth-viz
          .circle-label
            font-size: 13px !important

          .y.axis
            .tick
              text
                font-size: 10px !important

          .coverage-problem-glyph
            fill: $coverage-problem-glyph-color

        .gene-viz
          svg
            .transcript.current
              outline: none !important

      #conservation-track
        .conservation-score-label
          font-size: 12px
        .gene-viz
          svg
            .transcript.current
              outline: none !important

  .rel-header
    font-style: italic

  .variant-header
    color: $app-color
    font-size: 14px

  #variant-heading
    color: $app-color
    padding-bottom: 5px
    font-size: 16px
    padding-top: 0px
    min-width: 180px
    display: flex
    justify-content: flex-start


  .variant-action-button
      padding: 0px
      height: 22px !important
      margin: 0px
      min-width: 110px !important
      max-width: 110px
      font-weight: 500
      color: $link-color

      .btn__content, .v-btn__content
        color: $link-color !important
        padding-left: 8px
        padding-right: 8px
        font-size: 12px

        i.material-icons
          color: $link-color !important

  .variant-action-button-dbSnp
      color: rgb(113,113,113)
      font-size: 13px
      padding-left: 0
      padding-right: 15px
      height: 22px !important
      margin: 0px
      min-width: 110px !important
      max-width: 110px
      font-weight: 500

      .btn__content, .v-btn__content
          padding-right: 8px
          font-size: 12px

          i.material-icons
              color: $link-color !important



  .pedigree-chart
    circle
      fill: none
      stroke: black
      stroke-width: 1px

    rect
      stroke: black
      stroke-width: 1px
      fill: none

    .half-circle
      path
        fill: none
        stroke: black
        stroke-width: 1px

    .half-diamond
      path
        fill: none
        stroke: black
        stroke-width: 1px

    rect.het
      stroke: none !important

    .het, .hom
      fill: #c5c5c5 !important
      stroke: black

    .half-circle
      path.het
        fill: #c5c5c5 !important
        stroke: black
    .half-diamond
      path.het
        fill: #c5c5c5 !important
        stroke: black


    .het.critical.proband, .hom.critical.proband
      fill: #c5c5c5 !important

    .half-diamond
      path.het.critical.proband
        fill: #c5c5c5 !important

    line
      stroke: black !important


    .proband
      stroke: $current-color !important
      stroke-width: 3px !important

    .allele-count-bar
      rect.alt-count
        fill: $current-color
        opacity: .65

      text
        font-size: 11px
        text-anchor: middle
</style>

<style lang="css">


</style>


<template>

  <v-card v-show="selectedVariant" id="variant-inspect" class="app-card full-width">

    <div style="display:flex;align-items:flex-start;justify-content:flex-start;margin-bottom:10px">
      <div  id="variant-heading" v-if="selectedVariant" class="text-xs-left">
        <span class="pr-1" v-if="selectedVariantRelationship != 'proband'">
          <span class="rel-header">{{ selectedVariantRelationship | showRelationship }}</span>
        </span>

        Variant in {{ selectedGene.gene_name }}



      </div>

      <variant-links-menu
      v-if="selectedVariant && info"
      :selectedGene="selectedGene"
      :selectedVariant="selectedVariant"
      :geneModel="cohortModel.geneModel"
      :info="info">
      </variant-links-menu>

      <span v-if="!info || (info.HGVSpLoading && info.HGVScLoading)"
        style="font-size:13px;margin-top:2px;min-width:80px;margin-left:0px;margin-right:0px"
        v-show="selectedVariantRelationship != 'known-variants'" class=" loader vcfloader" >
        <img src="../../../assets/images/wheel.gif">
        HGVS
      </span>

      <variant-aliases-menu
      v-show="selectedVariant && (!info.HGVSpLoading || !info.HGVScLoading)"
      v-if="selectedVariant && selectedVariantRelationship != 'known-variants'"
      :label="`HGVS`"
      :selectedGene="selectedGene"
      :selectedVariant="selectedVariant"
      :geneModel="cohortModel.geneModel"
      :info="info">
      </variant-aliases-menu>

      <v-badge class="info" style="margin-top:2px;margin-right:10px" v-if="selectedVariant && selectedVariant.multiallelic && selectedVariant.multiallelic.length > 0">multiallelic</v-badge>


        <!--<span>-->
            <!--<v-btn flat dense small v-if="info && info.rsId && info.rsId != ''"-->
                                 <!--class="variant-action-button-dbSnp"  @click="launchDbSnp">-->
                               <!--{{info.rsId}}-->
               <!--<v-icon>open_in_new</v-icon>-->
              <!--</v-btn>-->
        <!--</span>-->

        <div v-if="info && info.rsId" style="display: inline-flex; padding-right:20px; font-size:14px; line-height:15px; padding-top: 5px; font-weight: 100"> {{info.rsId}}
        <a  v-bind:href="info.dbSnpUrl" target="ClinVar" style="padding-left: 4px;">
            <i aria-hidden="true" class="v-icon link-icon material-icons theme--light" style="font-size: 15px;color: #30638e;">open_in_new</i>
        </a>
        </div>

      <app-icon
       style="min-width:35px;margin-top:1px;margin-right:5px;padding-top: 2px;margin-right:10px"
       icon="zygosity" v-if="selectedVariant && selectedVariant.zygosity"
       :type="selectedVariant.zygosity.toLowerCase() + '-large'"
       height="14" width="35">
      </app-icon>

      <span v-if="selectedVariant" class="variant-header" style="margin-top:2px">

        <span style="vertical-align:top">{{ selectedVariant.type ? selectedVariant.type.toUpperCase() : "" }}</span>
        <span style="vertical-align:top" class="pl-1">{{ coord }}</span>
        <span class="pl-1 refalt">{{ refAlt  }}</span>


      </span>



      <span class="pl-3 variant-header aa-change" style="margin-top:2px">{{ aminoAcidChange }}</span>





      <v-spacer></v-spacer>

      <div v-if="selectedVariant && !showAssessment && selectedVariantInterpretation != 'known-variants'" style="margin-left:20px;margin-right:0px">
        <v-btn raised id="show-assessment-button" @click="onEnterComments">
          <v-icon>gavel</v-icon>
          Review
        </v-btn>
      </div>

    </div>



    <div class="variant-inspect-body">
      <div class="variant-inspect-column" v-if="selectedVariantRelationship != 'known-variants'">
          <div class="variant-column-header">
            Quality
            <v-divider></v-divider>
          </div>
          <variant-inspect-quality-row
            :info="getQualityInfo()"  >
          </variant-inspect-quality-row>


          <div id="qual-track" style="width:130px;">
            <depth-viz
              v-if="cohortModel && hasAlignments"
              ref="depthVizRef"
              :data="coverage"
              :coverageMedian="cohortModel.filterModel.geneCoverageMedian"
              :coverageDangerRegions="coverageDangerRegions"
              :currentPoint="coveragePoint"
              :maxDepth="cohortModel.maxDepth"
              :regionStart="coverageRegionStart"
              :regionEnd="coverageRegionEnd"
              :width="150"
              :margin="depthVizMargin"
              :height="120"
              :showTooltip="false"
              :showXAxis="false"
              :regionGlyph="depthVizRegionGlyph"
              :showAlleleBar="true"
              @region-selected="showExonTooltip"

            >
            </depth-viz>
            <gene-viz id="qual-gene-viz" class="gene-viz"
              v-if="cohortModel && hasAlignments"
              v-show="filteredTranscript && filteredTranscript.features && filteredTranscript.features.length > 0"
              :data="[filteredTranscript]"
              :margin="geneVizMargin"
              :width="130"
              :height="16"
              :trackHeight="geneVizTrackHeight"
              :cdsHeight="geneVizCdsHeight"
              :regionStart="coverageRegionStart"
              :regionEnd="coverageRegionEnd"
              :showXAxis="false"
              :showBrush="false"
              :featureClass="getExonClass"
              @feature-selected="showExonTooltip"
              >
            </gene-viz>

            <div class="variant-row " style="padding-top:5px">
              <v-btn flat v-if="selectedVariantRelationship != 'known-variants' && cohortModel.getModel(selectedVariantRelationship ? selectedVariantRelationship : 'proband').isBamLoaded() "
              class="variant-action-button"  @click="onShowPileup">
               <v-icon>format_align_center</v-icon>
               Read Pileup
              </v-btn>
            </div>
          </div>

      </div>
      <div class="variant-inspect-column " v-if="selectedVariant && showGenePhenotypes" >
          <div class="variant-column-header">
            Gene Associations
            <v-divider></v-divider>
          </div>
          <div v-if="genePhenotypeHits" v-for="geneHit in genePhenotypeHits" :key="geneHit.key" class="variant-row" style="flex-flow:column">
            <div v-for="geneRank in geneHit.geneRanks" :key="geneRank.rank">
              <div>
                <v-chip class="high">#{{ geneRank.rank }}</v-chip>
                <span v-if="geneRank.source" class="pheno-source">{{ geneRank.source }}</span>
                <span v-if="geneHit.searchTerm" class="pheno-search-term">{{ geneHit.searchTerm }}</span>
              </div>
            </div>
          </div>
      </div>
      <div class="variant-inspect-column" v-if="selectedVariant && info">
          <div class="variant-column-header">
            Pathogenicity
            <v-divider></v-divider>
          </div>
          <variant-inspect-row  v-for="clinvar,clinvarIdx in info.clinvarLinks" :key="clinvarIdx"
            :clazz="getClinvarClass(clinvar.significance)" :value="clinvar.clinsig" :label="`ClinVar`" :link="clinvar.url" >
          </variant-inspect-row>

          <div v-if="info.clinvarTrait.length > 0" class="variant-row no-icon no-top-margin small-font">
            <span>{{ info.clinvarTrait }} </span>
          </div>

          <variant-inspect-row
            :clazz="getImpactClass(info.vepImpact)" :value="info.vepConsequence"  :label="``"  >
          </variant-inspect-row>

          <variant-inspect-row
             v-if="info.vepHighestImpactValue.length > 0 && info.vepImpact.toUpperCase() != info.vepHighestImpactValue.toUpperCase()"
            :clazz="getImpactClass(info.vepHighestImpactValue)" :label=" `Most severe impact in non-canonical transcript`"  >
          </variant-inspect-row>

          <div v-if="info.vepHighestImpactValue.length > 0 && info.vepImpact.toUpperCase() != info.vepHighestImpactValue.toUpperCase()" class="variant-row no-icon no-top-margin">

                    <span v-for="(impactRec, idx) in info.vepHighestImpactRecs" :key="impactRec.impact">
                      <div style="padding-top:5px" v-for="(effectRec, idx1) in impactRec.effects" :key="effectRec.key">
                        {{ getNonCanonicalEffectDisplay(idx1, effectRec) }}
                        <v-btn class="change-transcript-button" flat v-for="transcriptId in effectRec.transcripts"
                         :key="transcriptId"
                         @click="selectTranscript(transcriptId)">
                          {{ transcriptId }}
                        </v-btn>
                      </div>
                    </span>

          </div>

          <variant-inspect-row v-if="info.revel != '' && info.revel"
            :clazz="getRevelClass(info)" :value="info.revel"   :label="`REVEL`" >
          </variant-inspect-row>
      </div>


      <div class="variant-inspect-column" v-if="selectedVariant && selectedVariantRelationship != 'known-variants'">
          <div class="variant-column-header">
              Pop Freq in gnomAD
            <info-popup name="gnomAD"></info-popup>
            <v-divider></v-divider>
          </div>
          <variant-inspect-row :clazz="afGnomAD.class" :value="afGnomAD.percent" :label="`Allele freq`" :link="afGnomAD.link" >
          </variant-inspect-row>
          <variant-inspect-row v-if="afGnomAD.percentPopMax" :clazz="afGnomAD.class" :value="afGnomAD.percentPopMax" :label="`Pop max allele freq`" >
          </variant-inspect-row>
          <div v-if="afGnomAD.totalCount > 0" class="variant-row no-icon">
            <span>{{ afGnomAD.altCount }} alt of {{ afGnomAD.totalCount }} total</span>
          </div>
          <div v-if="afGnomAD.homCount > 0"  class="variant-row no-icon">
            <span>{{ afGnomAD.homCount }} homozygotes</span>
          </div>
      </div>

      <div class="variant-inspect-column" style="min-width:90px" v-if="selectedVariant && selectedVariantRelationship != 'known-variants' && selectedVariant.inheritance.length > 0">
          <div class="variant-column-header">
            Inheritance
            <v-divider></v-divider>
          </div>

          <variant-inspect-inheritance-row :selectedVariant="selectedVariant" >
          </variant-inspect-inheritance-row>

          <div class="pedigree-chart">
            <app-icon class="hide" icon="affected"></app-icon>
            <pedigree-genotype-viz
             ref="pedigreeGenotypeViz"
             style="width:139px"
             :margin="{left: 15, right: 14, top: 30, bottom: 4}"
             :nodeWidth="30"
             :nodePadding="40"
             :nodeVerticalPadding="30"
             :data="pedigreeGenotypeData">
            </pedigree-genotype-viz>
          </div>


      </div>

      <div class="variant-inspect-column last" v-if="selectedVariant" style="min-width:130px;max-width:320px">
          <div class="variant-column-header" >
            Conservation
            <v-divider></v-divider>
          </div>
          <div id="conservation-track" style="display:flex;">
            <div style="display:flex;flex-direction: column;max-width:130px;min-width:130px;margin-right: 10px">

              <variant-inspect-row
                v-show="multiAlignModel && multiAlignModel.selectedScore && showConservation"
                :clazz="getConservationClass(conservationExactScore)"
                :value="getConservationScore(conservationExactScore)"   >
              </variant-inspect-row>

              <div class="conservation-score-label"
                v-if="conservationScores && conservationScores.length > 0">
                phyloP scores
              </div>

              <conservation-scores-viz class="conservation-scores-barchart exon"
               :data=conservationScores
               :options=conservationOptions
               :exactScore=conservationExactScore
               :targetScore=conservationTargetScore
               :margin="{top: 10, right: 2, bottom: 15, left: 4}"
               :width="130"
               :height="60">
              </conservation-scores-viz>

              <gene-viz id="conservation-gene-viz" class="gene-viz"
                v-if="cohortModel && showConservation"
                v-show="filteredTranscript && filteredTranscript.features && filteredTranscript.features.length > 0"
                :data="[filteredTranscript]"
                :margin="conservationGeneVizMargin"
                :height="16"
                :trackHeight="geneVizTrackHeight"
                :cdsHeight="geneVizCdsHeight"
                :regionStart="coverageRegionStart"
                :regionEnd="coverageRegionEnd"
                :showXAxis="false"
                :showBrush="false"
                :featureClass="getExonClass"
                @feature-selected="showExonTooltip"
                >
              </gene-viz>


            </div>
            <div style="min-width:190px" >


              <toggle-button
                v-if="false && hasConservationAligns"
                name1="Nuc"
                name2="AA"
                label="Sequence"
                buttonWidth="90"
               @click="onToggleConservationNucAA">
              </toggle-button>


              <span v-if="multialignInProgress" class="pt-4 loader multialign-loader" >
                  <img src="../../../assets/images/wheel.gif">
                  Loading sequence
              </span>

              <multialign-seq-viz style="margin-top:10px;"
              :data="multialignSequences"
              :margin="{top: 15, right: 0, bottom: 0, left: 70}"
              :selectedBase="multialignSelectedBase">
              </multialign-seq-viz>

            </div>
          </div>
      </div>

    </div>

  </v-card>

</template>

<script>

import Vue                      from "vue"
import AppIcon                  from "../partials/AppIcon.vue"
import VariantInspectRow        from "../partials/VariantInspectRow.vue"
import VariantInspectQualityRow from "../partials/VariantInspectQualityRow.vue"
import VariantInspectInheritanceRow from "../partials/VariantInspectInheritanceRow.vue"
import VariantLinksMenu         from "../partials/VariantLinksMenu.vue"
import VariantAliasesMenu       from "../partials/VariantAliasesMenu.vue"
import InfoPopup                from "../partials/InfoPopup.vue"
import ToggleButton             from '../partials/ToggleButton.vue'
import DepthViz                 from "../viz/DepthViz.vue"
import GeneViz                  from "../viz/GeneViz.vue"
import PedigreeGenotypeViz      from "../viz/PedigreeGenotypeViz.vue"
import ConservationScoresViz    from "../viz/ConservationScoresViz.vue"
import MultialignSeqViz         from "../viz/MultialignSeqViz.vue"



import BarChartD3               from '../../d3/BarChart.d3.js'
import MultiAlignD3             from '../../d3/MultiAlign.d3.js'
import MultiAlignModel          from "../../models/MultiAlignModel.js"


export default {
  name: 'variant-inspect-card',
  components: {
    AppIcon,
    InfoPopup,
    VariantLinksMenu,
    VariantAliasesMenu,
    VariantInspectRow,
    VariantInspectQualityRow,
    VariantInspectInheritanceRow,
    DepthViz,
    GeneViz,
    PedigreeGenotypeViz,
    ToggleButton,
    ConservationScoresViz,
    MultialignSeqViz
  },
  props: {
    selectedGene: null,
    selectedTranscript: null,
    selectedVariant: null,
    selectedVariantKey: null,
    selectedVariantInterpretation: null,
    selectedVariantRelationship: null,
    genomeBuildHelper: null,
    cohortModel: null,
    showGenePhenotypes: null,
    info: null,
    coverageDangerRegions: null,
    user: null,
    showAssessment: null
  },
  data() {
    return {
      genePhenotypeHits: null,

      coverageRegionStart: null,
      coverageRegionEnd: null,
      exon: null,
      coverage: null,
      coveragePoint: null,
      selectedExon: null,

      filteredTranscript: null,

      depthVizMargin: {
        top: 30,
        right: 2,
        bottom: 0,
        left: 4
      },
      geneVizMargin: {
        top: 0,
        right: 2,
        bottom: 0,
        left: 4
      },
      conservationGeneVizMargin: {
        top: 0,
        right: 2,
        bottom: 0,
        left: 4
      },
      geneVizTrackHeight: 16,
      geneVizCdsHeight: 12,

      multiAlignModel: new MultiAlignModel(),

      pedigreeGenotypeData: null,

      showConservation: false,
      hasConservationScores: false,
      hasConservationAligns: false,

      conservationSeqType: 'nuc',

      conservationScores: null,
      conservationOptions: null,
      conservationTargetScore: null,
      conservationExactScore: null,

      multialignSequences: null,
      multialignSelectedBase: null,
      multialignInProgress: false,

      enterCommentsClicked: false
    }
  },


  methods: {
    refresh: function() {

    },



    formatPopAF: function(afObject) {
      let self = this;
      var popAF = "";
      if (afObject['AF'] != ".") {
        for (var key in afObject) {
          if (key != "AF") {
            var label = key.split("_")[0];
            if (popAF.length > 0) {
              popAF += ", ";
            }
            popAF += label + " " + (afObject[key] == "." ? "0%" : self.globalApp.utility.percentage(afObject[key]));
          }
        }
      }
      return popAF;
    },
    selectTranscript: function(transcriptId) {
      this.$emit("transcript-id-selected", transcriptId);
    },
    getNonCanonicalImpactDisplay: function(idx, impactRec) {
      let buf = "";
      if (idx > 0) {
        buf += " | ";
      }
      buf += impactRec.impact.toLowerCase() + ' impact ';
      return buf;
    },
    getNonCanonicalEffectDisplay: function(idx, effectRec) {
      let buf = "";
      buf += this.globalApp.utility.capitalizeFirstLetter(effectRec.display) + " in ";
      return buf;
    },
    onShowPileup: function() {
      this.$emit("show-pileup-for-variant",
        this.selectedVariantRelationship ? this.selectedVariantRelationship : 'proband',
        this.selectedVariant);
    },



    formatCanonicalTranscript: function() {
      if (this.selectedTranscript) {
        return this.globalApp.utility.stripTranscriptPrefix(this.selectedTranscript.transcript_id);
      } else {
        return "";
      }
    },





    getNonCanonicalImpact: function(vepHighestImpact) {
      return this.globalApp.utility.capitalizeFirstLetter(vepHighestImpact.toLowerCase());
    },

    getQualityInfo: function() {
      let self  = this;
      if (self.selectedVariant == null) {
        return {clazz: '', depthClazz: '', altRatioClazz: '', reason: ''};
      }
      let genotype = self.selectedVariant.genotype;

      var zyg       =  genotype.zygosity.toLowerCase();
      var altAndRef = +genotype.refCount + +genotype.altCount;
      var altRatio  = (+genotype.altCount / +genotype.genotypeDepth);

      var info = {clazz: '', depthClazz: '', altRatioClazz: '', reason: ''}

      var depthThreshold = {'good':     self.cohortModel.filterModel.geneCoverageMin,
                            'moderate': self.cohortModel.filterModel.geneCoverageMin - 5};

      var altRatioThreshold = { 'good':     {'het': .1,   'hom': .6, 'homref': 0},
                                'moderate': {'het': .05,  'hom': .4, 'homref': 0} };

      var depthClazz = '';
      var altRatioClazz = '';

      if (+genotype.genotypeDepth >= depthThreshold.good) {
        info.depthClazz = 'good';
      } else if (+genotype.genotypeDepth >= depthThreshold.moderate) {
        info.depthClazz = 'moderate';
        info.reason += "Questionable sequence depth";
      } else {
        info.depthClazz = 'poor';
        info.reason += "Poor sequence depth";
      }

      if (altRatio >= altRatioThreshold.good[zyg]) {
        info.altRatioClazz = 'good';
      } else if (+genotype.genotypeDepth >= depthThreshold.moderate[zyg]) {
        info.altRatioClazz = 'moderate';
        if (info.reason.length > 0) {
          info.reason += ", ";
        }
        info.reason += "Questionable evidence of alternate allele";
      } else {
        info.altRatioClazz = 'poor';
        if (info.reason.length > 0) {
          info.reason += ", ";
        }
        info.reason += "Poor evidence of alternate allele";
      }

      if (info.depthClazz == 'good' && info.altRatioClazz == 'good') {
        info.clazz = 'good';
        info.reason = 'Sufficient depth and allele counts'
      } else if (info.depthClazz == 'poor' || info.altRatioClazz == 'poor') {
        info.clazz = 'poor';
      } else {
        info.clazz = 'moderate';
      }

      return info;
    },


    getRevelClass: function(info) {
      let self = this;
      let clazz = null;
      self.cohortModel.translator.revelMap.forEach(function(revelRange) {
      if (info.revel >= revelRange.min && info.revel < revelRange.max) {
          clazz = revelRange.clazz;
        }
      })

      if (clazz) {
        if (clazz == 'revel_high') {
          return 'level-high';
        } else if (clazz == 'revel_moderate') {
          return 'level-medium';
        } else {
          return 'level-unremarkable';
        }
      } else {
        return 'level-unremarkable';
      }

    },
    getAfClass: function(af) {
      if (af <= .01) {
        return 'level-high';
      } else if (af <= .05) {
        return 'level-medium';
      } else {
        return 'level-unremarkable';
      }
    },
    getImpactClass: function(impact) {
      if (impact && impact.toLowerCase() == 'high') {
        return 'level-high'
      } else if (impact && impact.toLowerCase() == 'moderate') {
        return 'level-medium'
      } else {
        return 'level-unremarkable';
      }
    },
    getClinvarClass: function(significance) {
      if (significance == 'clinvar_path' || significance == 'clinvar_lpath') {
        return 'level-high';
      } else if(significance == 'clinvar_cd') {
        return 'level-medium';
      } else if (significance == 'clinvar_benign' || significance == 'clinvar_lbenign') {
        return 'level-unremarkable';
      } else {
        return '';
      }
    },
    getConservationScore: function(score) {
      if (score == null) {
        return "";
      } else {
        if (score.y > 1.5) {
          return 'Highly conserved ' + score.y;
        } else if (score.y > 1) {
          return 'Moderately conserved ' + score.y;
        } else if (score.y > 0) {
          return 'Marginally conserved ' + score.y;
        } else {
          return 'Not conserved ' + score.y;
        }
      }
    },
    getConservationClass: function(score) {
      if (score == null) {
        return "";
      } else {
        if (score.y > 1.5) {
          return 'level-high'
        } else if (score.y > 1) {
          return 'level-medium'
        } else if (score.y > 0) {
          return 'level-low'
        } else {
          return 'level-unremarkable';
        }
      }
    },
    loadData: function() {
      let self = this;
      if (self.selectedVariant) {
        self.enterCommentsClicked = false;
        self.initPedigreeGenotypes();
        self.initGenePhenotypeHits();
        self.promiseInitCoverage()
        .then(function() {
          self.showMultiAlignments();
        })
      }
    },

    initPedigreeGenotypes() {
      let self = this;
      self.$set(self, "pedigreeGenotypeData", {});
      let thePedigreeGenotypeData = {}
      self.cohortModel.sampleModels.forEach(function(model) {
        if (model.relationship != 'known-variants' && model.relationship != 'sfari-variants') {
          let gtObject = {};
          gtObject.rel = model.relationship;
          gtObject.sex = model.sex
          gtObject.affectedStatus = model.affectedStatus;
          if (self.selectedVariant.genotypes && self.selectedVariant.genotypes[model.sampleName]) {
            let gt = self.selectedVariant.genotypes[model.sampleName];
            gtObject.zygosity = gt.zygosity.toLowerCase();

            var altAndRef = +gt.refCount + +gt.altCount;
            var altRatio  = (+gt.altCount / +gt.genotypeDepth);
            var otherCount = 0;
            var otherRatio = 0;
            if (altAndRef < +gt.genotypeDepth) {
              otherCount  = +gt.genotypeDepth - altAndRef;
              otherRatio  = (otherCount / +gt.genotypeDepth);
            }
            gtObject.altRatio   = altRatio;
            gtObject.altCount   = gt.altCount;
            gtObject.otherCount = otherCount;
            gtObject.otherRatio = otherRatio;
            gtObject.refCount   = gt.refCount;
            gtObject.totalCount = gt.genotypeDepth;


          } else {
            gtObject.zygosity = "unknown"
          }
          gtObject.inheritance = self.selectedVariant.inheritance;

          thePedigreeGenotypeData[gtObject.rel] = gtObject;
        }
      })
      let affectedStatusList = ['affected', 'unaffected'];
      affectedStatusList.forEach(function(affectedStatus) {
        if (self.cohortModel.sampleMapSibs[affectedStatus]) {
          self.cohortModel.sampleMapSibs[affectedStatus].forEach(function(model) {
            let gtObject = {};
            gtObject.rel = model.relationship;
            gtObject.sex = model.sex
            gtObject.affectedStatus = model.affectedStatus;
            if (self.selectedVariant.genotypes && self.selectedVariant.genotypes[model.sampleName]) {
              let gt = self.selectedVariant.genotypes[model.sampleName];
              gtObject.zygosity = gt.zygosity.toLowerCase();

              var altAndRef = +gt.refCount + +gt.altCount;
              var altRatio  = (+gt.altCount / +gt.genotypeDepth);
              var otherCount = 0;
              var otherRatio = 0;
              if (altAndRef < +gt.genotypeDepth) {
                otherCount  = +gt.genotypeDepth - altAndRef;
                otherRatio  = (otherCount / +gt.genotypeDepth);
              }
              gtObject.altRatio   = altRatio;
              gtObject.altCount   = gt.altCount;
              gtObject.otherCount = otherCount;
              gtObject.otherRatio = otherRatio;
              gtObject.refCount   = gt.refCount;
              gtObject.totalCount = gt.genotypeDepth;
            } else {
              gtObject.zygosity = "unknown"
            }
            gtObject.inheritance = self.selectedVariant.inheritance;

            thePedigreeGenotypeData['sibling-' + model.name] = gtObject;

          })

        }

      })
      self.$set(self, "pedigreeGenotypeData", thePedigreeGenotypeData);
      if (self.$refs.pedigreeGenotypeViz) {
        self.$refs.pedigreeGenotypeViz.update();
      } else {
        setTimeout(function() {
          if (self.$refs.pedigreeGenotypeViz) {
            self.$refs.pedigreeGenotypeViz.update();
          }
        },2000)
      }

    },

    initGenePhenotypeHits: function() {
      let self = this;
      self.genePhenotypeHits = [];
      if (self.selectedGene) {
        let searchTermRecs = self.cohortModel.geneModel.getGenePhenotypeHits(self.selectedGene.gene_name);
        if (searchTermRecs) {
          for (var searchTerm in searchTermRecs) {
            let searchTermLabel = searchTerm.split("_").join(" ");
            var rankRecs        = searchTermRecs[searchTerm];
            self.genePhenotypeHits.push( {key: searchTerm, searchTerm: searchTermLabel, geneRanks: rankRecs } );
          }
        }
      }
    },
    promiseInitCoverage: function() {
      let self = this;
      return new Promise(function(resolve, reject) {

        if (self.selectedVariant) {
          self.exon                = self.getExon();
          self.coverageRegionStart = self.getCoverageRegionStart();
          self.coverageRegionEnd   = self.getCoverageRegionEnd();
          self.conservationSeqType = "nuc";

          let theCoverage = self.cohortModel.getModel(self.selectedVariantRelationship).coverage.filter(function(coveragePoint) {
            return coveragePoint[0] >= self.coverageRegionStart && coveragePoint[0] <= self.coverageRegionEnd;
          })
          let clonedCoverage = [];
          theCoverage.forEach(function(covPoint) {
            let newPoint = []
            newPoint.push(covPoint[0])
            newPoint.push(covPoint[1])
            clonedCoverage.push(newPoint)
          })
          self.coverage = clonedCoverage
          setTimeout(function() {
            self.showCoverageAlleleBar();
            resolve();
          }, 100)


        } else {
          self.exon = null;
          self.coverageRegionStart = null;
          self.coverageRegionEnd = null;
          self.coverage = [];
          resolve();
        }
      })
    },
    showCoverageAlleleBar: function() {
      let self = this;
      let theDepth = self.selectedVariant.bamDepth;
      let theAltCount = null;
      // If samtools mpileup didn't return coverage for this position, use the variant's depth
      // field.
      if (theDepth == null || theDepth == '') {
        theDepth = self.selectedVariant.genotypeDepth;
      }
      if (self.selectedVariant.genotype && self.selectedVariant.genotype.altCount) {
        theAltCount = self.selectedVariant.genotype.altCount;
      }

      if (self.$refs.depthVizRef) {
        self.$refs.depthVizRef.showCurrentPoint({pos: self.selectedVariant.start, depth: theDepth, altCount: theAltCount});
      }

    },
    onApplyVariantNotes: function(variant) {
      this.$emit("apply-variant-notes", variant);
    },
    onApplyVariantInterpretation: function(variant) {
      this.$emit("apply-variant-interpretation", variant);
    },



    depthVizRegionGlyph: function(exon, regionGroup, regionX) {
      var exonId = 'exon' + exon.exon_number.replace("/", "-");
      if (regionGroup.select("g#" + exonId).empty()) {
        regionGroup.append('g')
              .attr("id", exonId)
              .attr('class',      'region-glyph coverage-problem-glyph')
              .attr('transform',  'translate(' + (regionX - 6) + ',-25)')
              .data([exon])
              .append('use')
              .attr('height',     '12')
              .attr('width',      '12')
              .attr('href', '#coverage-problem-symbol')
              .attr('xlink','http://www.w3.org/1999/xlink')
              .data([exon]);
      }
    },
    getExonClass: function(exon, i) {
      if (exon && exon.danger) {
        return exon.feature_type.toLowerCase() + (exon.danger.proband ? " danger" : "");
      } else {
        return exon.feature_type.toLowerCase();
      }
    },
    getExonNumber: function() {
      if (this.selectedVariant.hasOwnProperty("vepExon") && !$.isEmptyObject(this.selectedVariant.vepExon)) {
        return Object.keys(this.selectedVariant.vepExon)[0];
      } else {
        return null;
      }
    },

    getExon: function() {
      let self = this;
      let exonNumber = self.getExonNumber();
      if (exonNumber != null) {
        if (self.selectedTranscript && self.selectedTranscript.features) {
          var exons = self.selectedTranscript.features.filter(function(feature) {
            if ( feature.transcript_type == 'protein_coding'
                || feature.transcript_type == 'mRNA'
                || feature.transcript_type == 'transcript'
                || feature.transcript_type == 'primary_transcript') {
              return feature.feature_type.toLowerCase() == 'utr' || feature.feature_type.toLowerCase() == 'cds';
            } else {
              return feature.feature_type.toLowerCase() == 'exon';
            }
          })

          let theExon = exons.filter(function(feature) {
            return +feature.start <= +self.selectedVariant.start && +feature.end >= +self.selectedVariant.start;
          })

          self.filteredTranscript = $.extend({}, self.selectedTranscript);
          self.filteredTranscript.features = theExon;

          if (theExon && theExon.length > 0) {
            return theExon[0];
          } else {
            return null;
          }
        } else {
          return null;
        }
      } else {
        if (self.selectedTranscript) {
          self.filteredTranscript = $.extend({}, self.selectedTranscript);
          self.filteredTranscript.features = [];
        }
        return null;
      }
    },
    getCoverageRegionStart: function() {
      let self = this;

      if (self.exon) {
        let exonWidth = +self.exon.end  -  +self.exon.start;
        return +self.exon.start - Math.round(exonWidth * .60);
      } else  {
        return +self.selectedVariant.start - 1000;
      }
    },
    getCoverageRegionEnd: function() {
      let self = this;
      if (self.exon) {
        let exonWidth = +self.exon.end  -  +self.exon.start;
        return +self.exon.end + Math.round(exonWidth * .60);
      } else  {
        return +self.selectedVariant.start + 1000;
      }
    },
    showExonTooltip: function(featureObject, feature, lock) {
      let self = this;
      let tooltip = d3.select("#exon-tooltip");

        if (featureObject == null) {
        self.hideExonTooltip();
        return;
      }

      if (self.selectedExon) {
        return;
      }

      if (lock) {
        self.selectedExon = feature;
        tooltip.style("pointer-events", "all");
        tooltip.classed("locked", true);
      } else {
        tooltip.style("pointer-events", "none");
        tooltip.classed("locked", false);
      }

      var coverageRow = function(fieldName, coverageVal, covFields) {
        var row = '<div>';
        row += '<span style="padding-left:10px;width:60px;display:inline-block">' + fieldName   + '</span>';
        row += '<span style="width:40px;display:inline-block">' + d3.round(coverageVal) + '</span>';
        row += '<span class="' + (covFields[fieldName] ? 'danger' : '') + '">' + (covFields[fieldName] ? covFields[fieldName]: '') + '</span>';
        row += "</div>";
        return row;
      }

      let html = self.globalApp.utility.formatExonTooltip(self.cohortModel.filterModel,
                                                          self.selectedVariantRelationship,
                                                          coverageRow,
                                                          feature,
                                                          lock)

      tooltip.html(html);
      if (lock) {
        tooltip.select("#exon-tooltip-thresholds").on("click", function() {
          self.$emit("show-coverage-cutoffs");
        })
        tooltip.select("#exon-tooltip-close").on("click", function() {
          self.selectedExon = null;
          self.hideExonTooltip(true);
        })
      }

      var coord = self.globalApp.utility.getTooltipCoordinates(featureObject.node(),
        tooltip, self.$el.offsetWidth, 15);
      tooltip.style("left", coord.x + "px")
             .style("text-align", 'left')
             .style("top", (coord.y-60) + "px");

      tooltip.style("z-index", 1032);
      tooltip.transition()
             .duration(200)
             .style("opacity", .9);
    },
    hideExonTooltip: function(force) {
      let self = this;
      let tooltip = d3.select("#exon-tooltip");
      if (force || !self.selectedExon) {
        tooltip.classed("locked", false);
        tooltip.classed("black-arrow-left", false);
        tooltip.classed("black-arrow-right", false);
        tooltip.style("pointer-events", "none");
        tooltip.transition()
           .duration(500)
           .style("opacity", 0);
      }
    },

    showMultiAlignments: function() {
      let self = this;
      self.showConservation = false;
      self.hasConservationScores = false;
      self.hasConservationAligns = false;
      self.conservationTargetScore = null;
      self.conservationExactScore = null;
      self.conservationScores = null;
      self.conservationOptions = null;
      self.multialignSequences = null;
      self.multialignSelectedBase = null;
      self.multialignInProgress = true;

      let promises = [];
      let p1 = self.multiAlignModel.promiseGetConservationScores(self.coverageRegionStart,
                                                  self.coverageRegionEnd,
                                                  self.selectedGene,
                                                  self.selectedVariant,
                                                  self.genomeBuildHelper.getBuildAlias(self.genomeBuildHelper.ALIAS_UCSC))
      .then(function(data) {
        if (data) {
          self.conservationExactScore  = data.selectedScore;
          self.conservationTargetScore = data.targetScore;
          self.conservationScores      = data.scores;
          self.conservationOptions     = data.options;
          self.hasConservationScores   = self.multiAlignModel.hasConservationScores(self.coverageRegionStart,
                                                                                    self.coverageRegionEnd,
                                                                                    self.selectedGene);
          self.showConservation =  self.hasConservationScores || self.hasConservationAligns;
        }
      });
      promises.push(p1);


      let p2 = self.multiAlignModel.promiseGetMultiAlignments(self.selectedGene,
                                                  self.selectedVariant,
                                                  self.genomeBuildHelper.getBuildAlias(self.genomeBuildHelper.ALIAS_UCSC),
                                                  self.conservationSeqType)
      .then(function(data) {
        if (data) {
          self.multialignSelectedBase = data.selectedBase;
          self.multialignSequences    = data.sequences;
          self.hasConservationAligns  = data.sequences.length > 0;
          self.multialignInProgress = false;
        }
      })
      .catch(function(error) {
        self.multialignInProgress = false;
      })
      promises.push(p2)

      Promise.all(promises)
      .then(function() {
        self.showConservation =  self.hasConservationScores || self.hasConservationAligns;
      })

    },
    onToggleConservationNucAA: function(seqType) {
      let self = this;
      if (self.selectedVariant) {
        self.multialignInProgress = true;
        self.conservationSeqType = seqType.toLowerCase();
        self.multiAlignModel.promiseGetMultiAlignments(self.selectedGene,
                                                    self.selectedVariant,
                                                    self.genomeBuildHelper.getBuildAlias(self.genomeBuildHelper.ALIAS_UCSC),
                                                    self.conservationSeqType)
        .then(function(data) {
          if (data) {
            self.multialignInProgress   = false;
            self.multialignSequences    = data.sequences;
            self.multialignSelectedBase = data.selectedBase;
          }
        })
        .catch(function(data) {
          self.multialignInProgress = false;
        })
      }
    },
    onEnterComments: function() {
      this.$emit("show-variant-assessment", true)
      this.enterCommentsClicked = true;
    }
  },


  computed: {
    hasAlignments: function() {
      if (this.selectedVariantRelationship) {
        return this.cohortModel.getModel(this.selectedVariantRelationship).isBamLoaded();
      } else {
        return false;
      }
    },
    hgvsLabel: function() {
      if (this.selectedVariant && this.selectedVariant.extraAnnot && this.info.HGVSpAbbrev && this.info.HGVSpAbbrev.length > 0) {
        return this.info.HGVSpAbbrev;
      } else {
        return 'HGVS';
      }
    },


    coord: function() {
      let self = this;
      if (self.selectedVariant) {
        return self.selectedVariant.chrom + ":" + self.selectedVariant.start;
      } else {
        return "";
      }
    },

    refAlt: function() {
      let self = this;
      var refAlt = "";
      if (self.selectedGene && self.selectedGene.strand && self.selectedVariant) {
        if (self.isEduMode) {
          if (self.selectedGene.strand == "-") {
            refAlt = self.globalApp.utility.switchGenotype(self.selectedVariant.eduGenotype)
          } else {
            refAlt = self.selectedVariant.eduGenotype;
          }
        } else {
          refAlt =   self.selectedVariant.ref + "->" + self.selectedVariant.alt;
          if (self.selectedVariant.ref == '' && self.selectedVariant.alt == '') {
            refAlt = '(' + variant.len + ' bp)';
          }

        }
      }
      return refAlt;
    },
    aminoAcidChange: function() {
      let aaChange = "";
      let self = this;
      if (self.selectedVariant && Object.keys(self.selectedVariant.vepAminoAcids).join("").length > 0) {
        for (let aa in self.selectedVariant.vepAminoAcids) {
          aaChange += self.globalApp.utility.formatAminoAcidChange(aa)
        }
        if (Object.keys(self.selectedVariant.vepProteinPosition).join("").length > 0) {
          aaChange += " at " + Object.keys(self.selectedVariant.vepProteinPosition).join(" ");
        }
      }
      if (aaChange.length > 0) {
        return aaChange;
      } else {
        return "";
      }
    },
    afGnomAD: function() {
      if (this.selectedVariant) {
        if (this.globalApp.gnomADExtraAll || (this.globalApp.gnomADExtra && this.selectedVariant.extraAnnot)) {
          if (this.selectedVariant.gnomAD == null || this.selectedVariant.gnomAD.af == null) {
            return {percent: "?", link: null, class: ""};
          } else if (this.selectedVariant.gnomAD.af  == '.') {
            return {percent: "0%", link: null, class: "level-high"};
          } else  {
            var gnomAD = {};
            gnomAD.link =  "http://gnomad.broadinstitute.org/variant/"
              + this.selectedVariant.chrom + "-"
              + this.selectedVariant.start + "-"
              + this.selectedVariant.ref + "-"
              + this.selectedVariant.alt;

            if (this.genomeBuildHelper.getCurrentBuildName() == 'GRCh38') {
              gnomAD.link += "?dataset=gnomad_r3"
            };

            gnomAD.percent       = this.globalApp.utility.percentage(this.selectedVariant.gnomAD.af);
            gnomAD.class         = this.getAfClass(this.selectedVariant.gnomAD.af);
            gnomAD.percentPopMax = this.selectedVariant.gnomAD.afPopMax != '.' ? this.globalApp.utility.percentage(this.selectedVariant.gnomAD.afPopMax) : '0%';
            gnomAD.altCount      = this.selectedVariant.gnomAD.altCount;
            gnomAD.totalCount    = this.selectedVariant.gnomAD.totalCount;
            gnomAD.homCount      = this.selectedVariant.gnomAD.homCount;
            return gnomAD;

          }
        } else {
          if (this.selectedVariant.vepAf == null || this.selectedVariant.vepAf.gnomAD.AF == null) {
            return {percent: "?", link: null, class: ""};
          } else if (this.selectedVariant.vepAf.gnomAD.AF == ".") {
            return {percent: "0%", link: null, class: "level-high"};
          } else  {
            var gnomAD = {};
            gnomAD.link =  "http://gnomad.broadinstitute.org/variant/"
              + this.selectedVariant.chrom + "-"
              + this.selectedVariant.start + "-"
              + this.selectedVariant.ref + "-"
              + this.selectedVariant.alt;

            if (this.genomeBuildHelper.getCurrentBuildName() == 'GRCh38') {
              gnomAD.link += "?dataset=gnomad_r3"
            };

            gnomAD.percent       = this.globalApp.utility.percentage(this.selectedVariant.vepAf.gnomAD.AF);
            gnomAD.class         = this.getAfClass(this.selectedVariant.vepAf.gnomAD.AF);
            gnomAD.percentPopMax = 0;
            gnomAD.altCount      = 0;
            gnomAD.totalCount    = 0;
            gnomAD.homCount      = 0;
            return gnomAD;
          }

        }
      }
    }
  },

  watch: {

    selectedVariant: function() {
      this.$nextTick(function() {
        this.loadData();
      })
    },
  },

  filters: {

    showRelationship: function(buf) {
      if (buf == null) {
        return "";
      } else if (buf == 'known-variants') {
        return 'ClinVar';
      } else {
        // Capitalize first letter
        return buf.charAt(0).toUpperCase() + buf.slice(1);
      }
    },



  },

  updated: function() {

  },

  mounted: function() {
  },

  created: function() {
  }


}
</script>


